---
title: "Posterior draws from a fitted model"
author: "Claus O. Wilke"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 4,
  comment = "#>"
)

animate = FALSE
animate = TRUE # uncomment to build animated plots
```


For static plots, we need to set the group aesthetic manually, via `aes(group = stat(.draw))`, to ensure the separate draws are plotted as distinct lines.

```{r mpg-smooth-draws}
library(ggplot2)
library(ungeviz)

ggplot(mtcars, aes(hp, mpg)) +
  geom_point() +
  stat_smooth_draws(aes(group = stat(.draw)), size = 0.5) +
  theme_bw()
```

The number of draws we generate is controlled by the `times` parameter of `stat_smooth_draws()`.

```{r changing-draw-numbers, fig.width=6, fig.asp = 3/4}
library(purrr)
library(glue)

plist <- map(
  c(2, 5, 10, 20),
  ~ ggplot(mtcars, aes(hp, mpg)) +
      geom_point() +
      stat_smooth_draws(
        times = .x,  # this line specifies the number of draws
        aes(group = stat(.draw)), size = 0.5
      ) +
      annotate(
        "label", x = Inf, y = Inf, hjust = 1, vjust = 1, 
        label = glue("{.x} draws", size = 12/.pt)
      ) +
      theme_bw()
)

cowplot::plot_grid(plotlist = plist)

```

If we want to generate linear fits instead of spline fits, we can set the `formula` argument to `formula = y ~ x`.

```{r mpg-linear-draws}
ggplot(mtcars, aes(hp, mpg)) +
  geom_point() +
  stat_smooth_draws(aes(group = stat(.draw)), formula = y ~ x, size = 0.5) +
  theme_bw()
```

It can happen that we want to group both by draws and by some other variable, in case we want to generate draws for multiple different subsets of the data at the same time. We can do so with one caveat. We have to use the mapped version of the respective data column (e.g., map it to `colour` and then use `colour` on the right side of the aesthetic specification) because we're creating the groups after after initial data mapping. We can use `interaction()` to combine different grouping variables, e.g. here `stat(.draw)` and `colour`.

```{r iris-linear, fig.width = 5, fig.asp = 3/4}
ggplot(iris, aes(Sepal.Length, Sepal.Width, colour = Species)) +
  geom_point() +
  stat_smooth_draws(
    times = 5,
    formula = y ~ x,
    aes(group = interaction(stat(.draw), colour)),
    size = 0.5
  ) +
  theme_bw() + theme(legend.position = "bottom")
```

When making a HOP animation, we don't need to set the `group` aesthetic, because we are now transitioning animation frames based on the distinct draws. Note that we have to use `stat(.draw)` instead of just `.draw` as the argument to `transition_states()`, because the `.draw` column is not present in the original dataset. It is generated by `stat_smooth_draws()`.

```{r mpg-smooth-draws-animated, eval = animate}
library(gganimate)

ggplot(mtcars, aes(hp, mpg)) +
  #geom_point() +
  stat_smooth_draws(size = 0.5) +
  theme_bw() +
  transition_states(stat(.draw), 1, 2)
```


In a direct comparison between posterior draws and bootstrapped fits, we see that bootstrapping leads to curves that either tend to look similar or quite different from each other, whereas posterior draws cover the outcome space more uniformly. This happens because in bootstrapping the influence of individual data points varies in discrete steps, from nothing (when a data point is dropped in a bootstrap) to several multiples (when a data point is chosen three or four times).

```{r posterior-draws-bootstrap, fig.width = 6, fig.asp = 6/4}
p1 <- ggplot(mtcars, aes(hp, mpg)) +
  geom_point() +
  stat_smooth_draws(times = 20, aes(group = stat(.draw)), size = 0.3) +
  theme_bw() +
  ggtitle("Posterior draws")

p2 <- ggplot(mtcars, aes(hp, mpg)) +
  geom_point() +
  geom_smooth(data = bootstrapper(20), aes(group = .draw), size = 0.3, se = FALSE) +
  theme_bw() +
  ggtitle("Bootstrap")

cowplot::plot_grid(p1, p2, ncol = 1)
```
